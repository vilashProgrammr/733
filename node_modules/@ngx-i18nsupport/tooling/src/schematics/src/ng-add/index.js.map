{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../../../projects/tooling/src/schematics/src/ng-add/index.ts"],"names":[],"mappings":"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","sourcesContent":["/**\r\n * Schematic to automatically add support for using @ngx-i18nsupport.\r\n * Will be called when you call 'ng add @ngx-i18nsupport/tooling'.\r\n */\r\n\r\nimport {\r\n    apply,\r\n    branchAndMerge,\r\n    chain,\r\n    mergeWith,\r\n    move, noop,\r\n    Rule,\r\n    SchematicContext,\r\n    SchematicsException,\r\n    template,\r\n    Tree,\r\n    url\r\n} from '@angular-devkit/schematics';\r\nimport {NgAddOptions} from './schema';\r\nimport {\r\n    stringUtils\r\n} from '../../schematics-core';\r\nimport {\r\n    defaultI18nLocale,\r\n    isValidLanguageSyntax,\r\n    OptionsAfterSetup,\r\n    setupCommonOptions,\r\n    WorkspaceSnaphot, PackageJsonSnapshot, addXliffmergeDependencyToPackageJson\r\n} from '../common';\r\n\r\n/**\r\n * Sets all options given by commandline or defaults.\r\n * It also checks values for correctness.\r\n * @param optionsFromCommandline command line options.\r\n * @param context use for error logging.\r\n * @param host the tree to lookup some workspace settings.\r\n * @return an object where all relevant values are set.\r\n */\r\nfunction setupOptions(optionsFromCommandline: NgAddOptions, host: Tree, context: SchematicContext): OptionsAfterSetup {\r\n    const options: OptionsAfterSetup = setupCommonOptions(optionsFromCommandline, host, context);\r\n    if (options.useXliffmergeBuilder) {\r\n        options.profileUsedByBuilder = undefined;\r\n    }\r\n    options.useComandlineForLanguages = optionsFromCommandline.useCommandlineForLanguages ?\r\n        optionsFromCommandline.useCommandlineForLanguages\r\n        : false;\r\n    const languagesFromCommandline = (optionsFromCommandline.languages) ? optionsFromCommandline.languages.split(',') : [];\r\n    if (!optionsFromCommandline.i18nLocale) {\r\n        if (languagesFromCommandline.length > 0) {\r\n            options.i18nLocale = languagesFromCommandline[0];\r\n        } else {\r\n            options.i18nLocale = defaultI18nLocale;\r\n        }\r\n    }\r\n    options.parsedLanguages = [options.i18nLocale];\r\n    if (optionsFromCommandline.languages) {\r\n        options.parsedLanguages.push(...languagesFromCommandline);\r\n    }\r\n    // remove duplicates\r\n    options.parsedLanguages = options.parsedLanguages.filter((v, i, a) => a.indexOf(v) === i);\r\n    for (const lang of options.parsedLanguages) {\r\n        if (!isValidLanguageSyntax(lang)) {\r\n            const msg = `\"${lang}\" is not a valid language code.`;\r\n            context.logger.fatal(msg);\r\n            throw new SchematicsException(msg);\r\n        }\r\n    }\r\n    return options;\r\n}\r\n\r\n// You don't have to export the function as default. You can also have more than one rule factory\r\n// per file.\r\n// noinspection JSUnusedGlobalSymbols\r\nexport function ngAdd(optionsFromCommandline: NgAddOptions): Rule {\r\n  return (host: Tree, context: SchematicContext) => {\r\n      const options: OptionsAfterSetup = setupOptions(optionsFromCommandline, host, context);\r\n      const templateSource = apply(url('./files'), [\r\n          template({\r\n              ...stringUtils,\r\n              ...(options as object),\r\n              'i18nLocale': options.i18nLocale,\r\n              'i18nFormat': options.i18nFormat\r\n          } as any),\r\n          move(options.path ? options.path : ''),\r\n      ]);\r\n\r\n      const angularJsonChanges: Rule = (tree: Tree, context2: SchematicContext) => {\r\n          const ws: WorkspaceSnaphot = new WorkspaceSnaphot(tree, context2);\r\n          options.parsedLanguages\r\n              .filter(lang => lang !== options.i18nLocale)\r\n              .forEach(lang => ws.addLanguageConfigurationToProject(options, lang));\r\n          if (options.useXliffmergeBuilder) {\r\n              ws.addBuilderConfigurationToProject(options);\r\n          }\r\n          ws.commit();\r\n      };\r\n      const packageJsonChanges: Rule = (tree: Tree, context2: SchematicContext) => {\r\n          const packageJson: PackageJsonSnapshot = new PackageJsonSnapshot('/', tree, context2);\r\n          packageJson.addExtractScript(options);\r\n          options.parsedLanguages\r\n              .filter(lang => lang !== options.i18nLocale)\r\n              .forEach(lang => packageJson.addStartScript(options, lang));\r\n          packageJson.commit();\r\n      };\r\n      return chain([\r\n          branchAndMerge(\r\n              chain([\r\n                  packageJsonChanges,\r\n                  angularJsonChanges,\r\n                  (options.useXliffmergeBuilder) ? noop() : mergeWith(templateSource)]\r\n              )\r\n          ),\r\n          addXliffmergeDependencyToPackageJson(options.skipInstall),\r\n      ])(host, context);\r\n  };\r\n}\r\n"]}