!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common"],t):t(e.preboot=e.preboot||{},e.ng.core,e.ng.common)}(this,function(e,r,d){"use strict";function y(e){for(var t=[],r=e.root,n=e.node,o=n;o&&o!==r.serverNode&&o!==r.clientNode;)t.push(o),o=o.parentNode;o&&t.push(o);for(var i=n.nodeName||"unknown",s=t.length-1;0<=s;s--)if((o=t[s]).childNodes&&0<s)for(var c=0;c<o.childNodes.length;c++)if(o.childNodes[c]===t[s-1]){i+="_s"+(c+1);break}return i}var t=new r.InjectionToken("PrebootNonce");function n(){return{prebootData:window.prebootData,getComputedStyle:window.getComputedStyle,document:document}}var o=function(){function e(){this.clientNodeCache={},this.replayStarted=!1}return e.prototype.setWindow=function(e){this.win=e},e.prototype.getWindow=function(){return this.win||(this.win=n()),this.win},e.prototype.replayAll=function(){var t=this;if(!this.replayStarted){this.replayStarted=!0;var e=this.getWindow().prebootData||{};(e.apps||[]).forEach(function(e){return t.replayForApp(e)}),this.cleanup(e)}},e.prototype.replayForApp=function(t){var r=this;t=t||{};try{(t.events||[]).forEach(function(e){return r.replayEvent(t,e)})}catch(e){console.error(e)}this.switchBuffer(t)},e.prototype.replayEvent=function(e,t){e=e||{};var r=(t=t||{}).event,n=t.node||{},o=t.nodeKey,i=this.findClientNode({root:e.root,node:n,nodeKey:o});i?(i.checked=n.checked,i.selected=n.selected,i.value=n.value,i.dispatchEvent(r)):console.warn("Trying to dispatch event "+r.type+" to node "+o+"\n        but could not find client node. Server node is: "+n)},e.prototype.switchBuffer=function(e){var t=(e=e||{}).root||{},r=t.serverNode,n=t.clientNode;if(n&&r&&r!==n&&"BODY"!==r.nodeName)try{var o=(0,this.getWindow().getComputedStyle)(r).getPropertyValue("display")||"block";r.remove?r.remove():r.style.display="none",n.style.display=o}catch(e){console.error(e)}},e.prototype.cleanup=function(e){var t=this,r=(e=e||{}).listeners||[],n=e.activeNode;null!=n&&setTimeout(function(){return t.setFocus(n)},1);for(var o=0,i=r;o<i.length;o++){var s=i[o];s.node.removeEventListener(s.eventName,s.handler)}var c=this.getWindow().document,u=c.getElementById("prebootOverlay");if(u&&(u.remove?u.remove():null!==u.parentNode?u.parentNode.removeChild(u):u.style.display="none"),e.apps=[],this.clientNodeCache={},"function"==typeof CustomEvent){var a=new CustomEvent("PrebootComplete");c.dispatchEvent(a)}else console.warn("Could not dispatch PrebootComplete event.\n       You can fix this by including a polyfill for CustomEvent.")},e.prototype.setFocus=function(e){if(e&&e.node&&e.nodeKey){var t=this.findClientNode(e);if(t){t.focus();var r=e.selection;if(t.setSelectionRange&&r)try{t.setSelectionRange(r.start,r.end,r.direction)}catch(e){}}}},e.prototype.findClientNode=function(e){var t=(e=e||{}).node,r=e.root;if(!r||!r.serverNode||!r.clientNode)return null;var n=e.nodeKey||y(e);if(this.clientNodeCache[n])return this.clientNodeCache[n];var o=(t.className||"").replace("ng-binding","").trim(),i=t.tagName;t.id?i+="#"+t.id:o&&(i+="."+o.replace(/ /g,"."));var s=r.clientNode,c=s.querySelectorAll(i);c.length||(console.log("nothing found for "+i+" so using "+t.tagName),c=s.querySelectorAll(t.tagName));for(var u=c.length,a=0;a<u;a++){var l=c.item(a);if(y({root:r,node:l})===n)return this.clientNodeCache[n]=l}return 1===c.length?(this.clientNodeCache[n]=c[0],c[0]):(console.warn("No matching client node found for "+n+".\n       You can fix this by assigning this element a unique id attribute."),null)},e}();function i(e,t){var r=t||window,n=r.prebootData={opts:e,apps:[],listeners:[]};return function(){return s(n,r)}}function s(t,e){var r=(e||window).document||{},n=r.currentScript||[].slice.call(r.getElementsByTagName("script"),-1)[0];if(n){var o=n.parentNode;if(o){o.removeChild(n);var i=(t.opts||{}).eventSelectors||[],s={root:t.opts?u(r,t.opts,o):null,events:[]};t.apps&&t.apps.push(s),(i=i.map(function(e){return e.hasOwnProperty("replay")||(e.replay=!0),e})).forEach(function(e){return a(r,t,s,e)})}else console.error("Preboot initialization failed, the script is detached")}else console.error("Preboot initialization failed, no currentScript has been detected.")}function c(e){var t=e.createElement("div");return t.setAttribute("id","prebootOverlay"),t.setAttribute("style","display:none;position:absolute;left:0;top:0;width:100%;height:100%;z-index:999999;background:black;opacity:.3"),e.documentElement.appendChild(t),t}function u(e,t,r){var n={serverNode:r};return n.clientNode=t.buffer?p(n):n.serverNode,t.disableOverlay||(n.overlay=c(e)),n}function a(r,n,o,i){var s=o.root.serverNode;s&&i.events.forEach(function(e){var t=l(r,n,i,o);s.addEventListener(e,t,!0),n.listeners&&n.listeners.push({node:s,eventName:e,handler:t})})}function l(e,c,u,a){var l=["keyup","keydown","focusin","mouseup","mousedown"],p=["INPUT","TEXTAREA"],f=e.documentElement.matches||e.documentElement.msMatchesSelector,h=c.opts;return function(t){var e=t.target;if(f.call(e,u.selector)){var r=a.root,n=t.type;if(e&&n){var o=u.keyCodes;if(o&&o.length)if(!o.filter(function(e){return t.which===e}).length)return;u.preventDefault&&t.preventDefault(),u.action&&u.action(e,t);var i=y({root:r,node:e});if(0<=l.indexOf(n)&&0<=p.indexOf(e.tagName?e.tagName:"")?c.activeNode={root:r,node:e,nodeKey:i,selection:b(e)}:"change"!==n&&"focusout"!==n&&(c.activeNode=void 0),h&&!h.disableOverlay&&u.freeze){var s=r.overlay;s.style.display="block",setTimeout(function(){s.style.display="none"},1e4)}u.replay&&a.events.push({node:e,nodeKey:i,event:t,name:n})}}}}function b(e){var t=(e=e||{}).value||"",r={start:t.length,end:t.length,direction:"forward"};try{(e.selectionStart||0===e.selectionStart)&&(r.start=e.selectionStart,r.end=e.selectionEnd?e.selectionEnd:0,r.direction=e.selectionDirection?e.selectionDirection:"none")}catch(e){}return r}function p(e){var t=e.serverNode;if(!t||!t.parentNode||t===document.documentElement||t===document.body)return t;var r=t.cloneNode(!1);return r.style.display="none",t.parentNode.insertBefore(r,t),t.setAttribute("ng-non-bindable",""),r}var f={start:s,createOverlay:c,getAppRoot:u,handleEvents:a,createListenHandler:l,getSelection:b,createBuffer:p},h="prebootInitFn",v={buffer:!0,replay:!0,disableOverlay:!1,eventSelectors:[{selector:"input,textarea",events:["keypress","keyup","keydown","input","change"]},{selector:"select,option",events:["change"]},{selector:"input",events:["keyup"],preventDefault:!0,keyCodes:[13],freeze:!0},{selector:"form",events:["submit"],preventDefault:!0,freeze:!0},{selector:"input,textarea",events:["focusin","focusout","mousedown","mouseup"],replay:!1},{selector:"button",events:["click"],preventDefault:!0,freeze:!0}]};function m(){var e=[];for(var t in f)if(f.hasOwnProperty(t)){var r=f[t].toString().replace("common_1.","");e.push(r)}return e.push(y.toString()),"\n\n"+e.join("\n\n")+"\n\n"}function g(e){var t=E({},v,e);w(t);var r=m(),n=S(t),o=i.toString();return"var "+h+" = (function() {\n      "+r+"\n      return ("+o.replace("common_1.","")+")("+n+");\n    })();"}function _(){return h+"();"}function w(e){if(!e.appRoot||!e.appRoot.length)throw new Error("The appRoot is missing from preboot options. This is needed to find the root of your application. Set this value in the preboot options to be a selector for the root element of your app.")}function E(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];if(null==e)throw new TypeError("Cannot convert undefined or null to object");for(var n=Object(e),o=0;o<t.length;o++){var i=t[o];if(null!=i)for(var s in i)i.hasOwnProperty&&i.hasOwnProperty(s)&&(n[s]=i[s])}return n}function S(e){for(var t,r,n="START_FUNCTION_HERE",o="STOP_FUNCTION_HERE",i=JSON.stringify(e,function(e,t){return t&&t.constructor&&t.call&&t.apply?n+t.toString()+o:t}),s=i.indexOf(n);0<=s;)t=i.indexOf(o),r=(r=i.substring(s+n.length,t)).replace(/\\n/g,"\n"),s=(i=i.substring(0,s-1)+r+i.substring(t+o.length+1)).indexOf(n);return i}var N=function(e,t){return(N=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function O(e,t){function r(){this.constructor=e}N(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var T,x={e:{}};function P(){try{return T.apply(this,arguments)}catch(e){return x.e=e,x}}function C(e){return T=e,P}function A(e){return"function"==typeof e}var D=!1,k={Promise:void 0,set useDeprecatedSynchronousErrorHandling(e){e&&(new Error).stack;D=e},get useDeprecatedSynchronousErrorHandling(){return D}};function R(e){setTimeout(function(){throw e})}var j={closed:!0,next:function(e){},error:function(e){if(k.useDeprecatedSynchronousErrorHandling)throw e;R(e)},complete:function(){}},H=Array.isArray||function(e){return e&&"number"==typeof e.length};function B(e){return null!=e&&"object"==typeof e}function I(e){return Error.call(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map(function(e,t){return t+1+") "+e.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e,this}I.prototype=Object.create(Error.prototype);var F=I,M=function(){function n(e){this.closed=!1,this._parent=null,this._parents=null,this._subscriptions=null,e&&(this._unsubscribe=e)}var e;return n.prototype.unsubscribe=function(){var e,t=!1;if(!this.closed){var r=this._parent,n=this._parents,o=this._unsubscribe,i=this._subscriptions;this.closed=!0,this._parent=null,this._parents=null,this._subscriptions=null;for(var s=-1,c=n?n.length:0;r;)r.remove(this),r=++s<c&&n[s]||null;if(A(o))C(o).call(this)===x&&(t=!0,e=e||(x.e instanceof F?U(x.e.errors):[x.e]));if(H(i))for(s=-1,c=i.length;++s<c;){var u=i[s];if(B(u))if(C(u.unsubscribe).call(u)===x){t=!0,e=e||[];var a=x.e;a instanceof F?e=e.concat(U(a.errors)):e.push(a)}}if(t)throw new F(e)}},n.prototype.add=function(e){if(!e||e===n.EMPTY)return n.EMPTY;if(e===this)return this;var t=e;switch(typeof e){case"function":t=new n(e);case"object":if(t.closed||"function"!=typeof t.unsubscribe)return t;if(this.closed)return t.unsubscribe(),t;if("function"!=typeof t._addParent){var r=t;(t=new n)._subscriptions=[r]}break;default:throw new Error("unrecognized teardown "+e+" added to Subscription.")}return(this._subscriptions||(this._subscriptions=[])).push(t),t._addParent(this),t},n.prototype.remove=function(e){var t=this._subscriptions;if(t){var r=t.indexOf(e);-1!==r&&t.splice(r,1)}},n.prototype._addParent=function(e){var t=this._parent,r=this._parents;t&&t!==e?r?-1===r.indexOf(e)&&r.push(e):this._parents=[e]:this._parent=e},n.EMPTY=((e=new n).closed=!0,e),n}();function U(e){return e.reduce(function(e,t){return e.concat(t instanceof F?t.errors:t)},[])}var z="function"==typeof Symbol?Symbol("rxSubscriber"):"@@rxSubscriber_"+Math.random(),K=function(o){function i(e,t,r){var n=o.call(this)||this;switch(n.syncErrorValue=null,n.syncErrorThrown=!1,n.syncErrorThrowable=!1,n.isStopped=!1,n._parentSubscription=null,arguments.length){case 0:n.destination=j;break;case 1:if(!e){n.destination=j;break}if("object"==typeof e){e instanceof i?(n.syncErrorThrowable=e.syncErrorThrowable,(n.destination=e).add(n)):(n.syncErrorThrowable=!0,n.destination=new V(n,e));break}default:n.syncErrorThrowable=!0,n.destination=new V(n,e,t,r)}return n}return O(i,o),i.prototype[z]=function(){return this},i.create=function(e,t,r){var n=new i(e,t,r);return n.syncErrorThrowable=!1,n},i.prototype.next=function(e){this.isStopped||this._next(e)},i.prototype.error=function(e){this.isStopped||(this.isStopped=!0,this._error(e))},i.prototype.complete=function(){this.isStopped||(this.isStopped=!0,this._complete())},i.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,o.prototype.unsubscribe.call(this))},i.prototype._next=function(e){this.destination.next(e)},i.prototype._error=function(e){this.destination.error(e),this.unsubscribe()},i.prototype._complete=function(){this.destination.complete(),this.unsubscribe()},i.prototype._unsubscribeAndRecycle=function(){var e=this._parent,t=this._parents;return this._parent=null,this._parents=null,this.unsubscribe(),this.closed=!1,this.isStopped=!1,this._parent=e,this._parents=t,this._parentSubscription=null,this},i}(M),V=function(c){function e(e,t,r,n){var o,i=c.call(this)||this;i._parentSubscriber=e;var s=i;return A(t)?o=t:t&&(o=t.next,r=t.error,n=t.complete,t!==j&&(A((s=Object.create(t)).unsubscribe)&&i.add(s.unsubscribe.bind(s)),s.unsubscribe=i.unsubscribe.bind(i))),i._context=s,i._next=o,i._error=r,i._complete=n,i}return O(e,c),e.prototype.next=function(e){if(!this.isStopped&&this._next){var t=this._parentSubscriber;k.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,this._next,e)&&this.unsubscribe():this.__tryOrUnsub(this._next,e)}},e.prototype.error=function(e){if(!this.isStopped){var t=this._parentSubscriber,r=k.useDeprecatedSynchronousErrorHandling;if(this._error)r&&t.syncErrorThrowable?this.__tryOrSetError(t,this._error,e):this.__tryOrUnsub(this._error,e),this.unsubscribe();else if(t.syncErrorThrowable)r?(t.syncErrorValue=e,t.syncErrorThrown=!0):R(e),this.unsubscribe();else{if(this.unsubscribe(),r)throw e;R(e)}}},e.prototype.complete=function(){var e=this;if(!this.isStopped){var t=this._parentSubscriber;if(this._complete){var r=function(){return e._complete.call(e._context)};k.useDeprecatedSynchronousErrorHandling&&t.syncErrorThrowable?this.__tryOrSetError(t,r):this.__tryOrUnsub(r),this.unsubscribe()}else this.unsubscribe()}},e.prototype.__tryOrUnsub=function(e,t){try{e.call(this._context,t)}catch(e){if(this.unsubscribe(),k.useDeprecatedSynchronousErrorHandling)throw e;R(e)}},e.prototype.__tryOrSetError=function(t,e,r){if(!k.useDeprecatedSynchronousErrorHandling)throw new Error("bad call");try{e.call(this._context,r)}catch(e){return k.useDeprecatedSynchronousErrorHandling?(t.syncErrorValue=e,t.syncErrorThrown=!0):(R(e),!0)}return!1},e.prototype._unsubscribe=function(){var e=this._parentSubscriber;this._context=null,this._parentSubscriber=null,e.unsubscribe()},e}(K);var q="function"==typeof Symbol&&Symbol.observable||"@@observable";function L(){}var W=function(){function r(e){this._isScalar=!1,e&&(this._subscribe=e)}return r.prototype.lift=function(e){var t=new r;return t.source=this,t.operator=e,t},r.prototype.subscribe=function(e,t,r){var n=this.operator,o=function(e,t,r){if(e){if(e instanceof K)return e;if(e[z])return e[z]()}return e||t||r?new K(e,t,r):new K(j)}(e,t,r);if(n?n.call(o,this.source):o.add(this.source||k.useDeprecatedSynchronousErrorHandling&&!o.syncErrorThrowable?this._subscribe(o):this._trySubscribe(o)),k.useDeprecatedSynchronousErrorHandling&&o.syncErrorThrowable&&(o.syncErrorThrowable=!1,o.syncErrorThrown))throw o.syncErrorValue;return o},r.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){k.useDeprecatedSynchronousErrorHandling&&(t.syncErrorThrown=!0,t.syncErrorValue=e),!function(e){for(;e;){var t=e,r=t.closed,n=t.destination,o=t.isStopped;if(r||o)return!1;e=n&&n instanceof K?n:null}return!0}(t)?console.warn(e):t.error(e)}},r.prototype.forEach=function(n,e){var o=this;return new(e=Y(e))(function(e,t){var r;r=o.subscribe(function(e){try{n(e)}catch(e){t(e),r&&r.unsubscribe()}},t,e)})},r.prototype._subscribe=function(e){var t=this.source;return t&&t.subscribe(e)},r.prototype[q]=function(){return this},r.prototype.pipe=function(){for(var t,e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];return 0===e.length?this:((t=e)?1===t.length?t[0]:function(e){return t.reduce(function(e,t){return t(e)},e)}:L)(this)},r.prototype.toPromise=function(e){var n=this;return new(e=Y(e))(function(e,t){var r;n.subscribe(function(e){return r=e},function(e){return t(e)},function(){return e(r)})})},r.create=function(e){return new r(e)},r}();function Y(e){if(e||(e=k.Promise||Promise),!e)throw new Error("no Promise impl found");return e}var J=new W(function(e){return e.complete()});function X(e){return e?(t=e,new W(function(e){return t.schedule(function(){return e.complete()})})):J;var t}function G(){return Error.call(this),this.message="argument out of range",this.name="ArgumentOutOfRangeError",this}G.prototype=Object.create(Error.prototype);var Q=G;var Z=function(){function e(e,t){this.predicate=e,this.thisArg=t}return e.prototype.call=function(e,t){return t.subscribe(new $(e,this.predicate,this.thisArg))},e}(),$=function(o){function e(e,t,r){var n=o.call(this,e)||this;return n.predicate=t,n.thisArg=r,n.count=0,n}return O(e,o),e.prototype._next=function(e){var t;try{t=this.predicate.call(this.thisArg,e,this.count++)}catch(e){return void this.destination.error(e)}t&&this.destination.next(e)},e}(K);Error.prototype;var ee=function(){function e(e){if(this.total=e,this.total<0)throw new Q}return e.prototype.call=function(e,t){return t.subscribe(new te(e,this.total))},e}(),te=function(n){function e(e,t){var r=n.call(this,e)||this;return r.total=t,r.count=0,r}return O(e,n),e.prototype._next=function(e){var t=this.total,r=++this.count;r<=t&&(this.destination.next(e),r===t&&(this.destination.complete(),this.unsubscribe()))},e}(K);Error.prototype;var re="preboot-inline-script",ne=new r.InjectionToken("PrebootOptions");function oe(e,t,r){var n=e.createElement("script");return t&&(n.nonce=t),n.className=re,n.textContent=r,n}function ie(u,a,l,p,f,h){return function(){if(w(a),d.isPlatformServer(p)){var e=g(a),t=oe(u,l,e),o=_(),r=u.getElementsByClassName(re);if(0===r.length){var n=[].concat(a.appRoot);u.head.appendChild(t),n.map(function(e){return{selector:e,appRootElem:u.querySelector(e)}}).forEach(function(e){var t=e.selector,r=e.appRootElem;if(r){var n=oe(u,l,o);r.insertBefore(n,r.firstChild)}else console.log("No server node found for selector: "+t)})}else 0<r.length&&l&&(r[0].nonce=l)}var i,s,c;d.isPlatformBrowser(p)&&((null==a.replay||a.replay)&&f.isStable.pipe((s=function(e){return e},function(e){return e.lift(new Z(s,c))}),(i=1,function(e){return 0===i?X():e.lift(new ee(i))})).subscribe(function(){h.replayAll()}))}}var se={provide:r.APP_BOOTSTRAP_LISTENER,useFactory:ie,deps:[d.DOCUMENT,ne,[new r.Optional,new r.Inject(t)],r.PLATFORM_ID,r.ApplicationRef,o],multi:!0},ce=function(){function t(){}return t.withConfig=function(e){return{ngModule:t,providers:[{provide:ne,useValue:e}]}},t.decorators=[{type:r.NgModule,args:[{providers:[o,se]}]}],t}();e.getNodeKeyForPreboot=y,e.PREBOOT_NONCE=t,e._window=n,e.EventReplayer=o,e.initAll=i,e.start=s,e.createOverlay=c,e.getAppRoot=u,e.handleEvents=a,e.createListenHandler=l,e.getSelection=b,e.createBuffer=p,e.getEventRecorderCode=m,e.getInlineDefinition=g,e.getInlineInvocation=_,e.validateOptions=w,e.assign=E,e.stringifyWithFunctions=S,e.initFunctionName=h,e.defaultOptions=v,e.PrebootModule=ce,e.ɵb=ie,e.ɵa=ne,e.ɵc=se,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=preboot.umd.min.js.map
